---
title: "R Notebook"
output: html_notebook
---

library(dplyr)
library(ggplot2)
library(urca)
library(TTR)
library(pastecs)
library(TSclust)
library(tidyr)
library(ggcorrplot)

Load data and add genres

```{r}
ratings<-read.csv("ratings.csv")
```

Select the movies which have top 500 number of ratings
```{r}
movie_rating_num<-summarise(group_by(ratings,movieId),rating_num=length(rating))
movie_index<-movie_rating_num$movieId[order(movie_rating_num$rating_num,decreasing = T)[1:500]]
ratings_topnum<-ratings[ratings$movieId %in% movie_index,]
```


Calculate the age of movie when being rated (for a given movie, age:=timestamp-min(timestamp))

```{r}
movie_firsttime<-summarise(group_by(ratings_topnum,movieId),firsttime=min(timestamp))
ratings_age<-ratings_topnum %>% left_join(movie_firsttime, by= c("movieId"="movieId"))
ratings_age<-ratings_age %>% mutate(age=timestamp-firsttime) %>% select(rating,movieId,age)
```

Calculate the mean rating for each age (10 intervals)

```{r}
ratings_age_cut<-ratings_age
ratings_age_cut$age<-cut(ratings_age_cut$age,10)
ratings_age_cut_group<-group_by(ratings_age_cut,movieId,age)
ratings_age_ts<-summarise(ratings_age_cut_group,mean_rating=mean(rating))
```

Transform dataframe (each column is a rating time series for a movie)
```{r}
ratings_age_ts<-spread(ratings_age_ts,movieId,mean_rating)[,-1]
```

Test trend and extract significant movies

```{r}
trend.p.value<-function(x){
  return(as.numeric(unlist(trend.test(x, R=1))[2]))
}
movie_trend.p.value<-lapply(ratings_age_ts,trend.p.value)
index<-names(movie_trend.p.value[movie_trend.p.value>0.05])
```









